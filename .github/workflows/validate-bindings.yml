name: Validate Bindings

on:
  push:
    tags: ['*']
  workflow_dispatch:

jobs:
  validate-cffi-surface:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: .python-version

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install cffi numpy

      - name: Clone llama.cpp headers (no build)
        env:
          LLAMA_CPP_REPO: https://github.com/ggerganov/llama.cpp.git
        run: |
          set -euo pipefail

          UPSTREAM_SHA=$(python -c "import json; print(json.load(open('.llama_cpp_sync_state.json','r',encoding='utf-8')).get('last_sync_sha',''))")
          if [ -z "${UPSTREAM_SHA}" ]; then
            echo "Missing last_sync_sha in .llama_cpp_sync_state.json" >&2
            exit 1
          fi

          rm -rf vendor/llama.cpp
          mkdir -p vendor/llama.cpp
          git init vendor/llama.cpp
          git -C vendor/llama.cpp remote add origin "${LLAMA_CPP_REPO}"
          git -C vendor/llama.cpp fetch --depth 1 origin "${UPSTREAM_SHA}"
          git -C vendor/llama.cpp checkout --detach FETCH_HEAD

      - name: Regenerate bindings (check only)
        run: |
          # Use the recorded upstream SHA for reproducible headers in the generated banner.
          UPSTREAM_SHA=$(python -c "import json; print(json.load(open('.llama_cpp_sync_state.json','r',encoding='utf-8')).get('last_sync_sha','unknown'))")
          python scripts/gen_bindings.py --commit-sha "$UPSTREAM_SHA"

      - name: Validate header, structs/enums, and signatures
        run: |
          python scripts/validate_cffi_surface.py --check-structs --check-enums --check-signatures

      - name: Ensure committed bindings are up-to-date
        run: |
          git diff --exit-code -- src/llama_cpp_py_sync/_cffi_bindings.py
