name: Cleanup Actions Storage

on:
  schedule:
    - cron: '0 0 */3 * *'
  workflow_dispatch:
    inputs:
      artifact_retention_days:
        description: 'Delete workflow artifacts older than N days'
        required: false
        default: '14'
      run_retention_days:
        description: 'Delete workflow runs older than N days'
        required: false
        default: '30'

permissions:
  actions: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    env:
      ARTIFACT_RETENTION_DAYS: ${{ github.event.inputs.artifact_retention_days || '14' }}
      RUN_RETENTION_DAYS: ${{ github.event.inputs.run_retention_days || '30' }}
    steps:
      - name: Delete old artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const retentionDays = Number(process.env.ARTIFACT_RETENTION_DAYS || '14')
            const cutoff = new Date(Date.now() - retentionDays * 24 * 60 * 60 * 1000)

            core.info(`Deleting artifacts older than ${retentionDays} days (created before ${cutoff.toISOString()})`)

            const artifacts = await github.paginate(github.rest.actions.listArtifactsForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100,
            })

            let deleted = 0
            for (const a of artifacts) {
              const createdAt = new Date(a.created_at)
              if (createdAt < cutoff) {
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: a.id,
                })
                deleted += 1
              }
            }

            core.info(`Deleted ${deleted} artifacts.`)

      - name: Delete old workflow runs
        uses: actions/github-script@v7
        with:
          script: |
            const retentionDays = Number(process.env.RUN_RETENTION_DAYS || '30')
            const cutoff = new Date(Date.now() - retentionDays * 24 * 60 * 60 * 1000)

            core.info(`Deleting workflow runs older than ${retentionDays} days (created before ${cutoff.toISOString()})`)

            const runs = await github.paginate(github.rest.actions.listWorkflowRunsForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              status: 'completed',
              per_page: 100,
            })

            let deleted = 0
            for (const r of runs) {
              const createdAt = new Date(r.created_at)
              if (createdAt < cutoff) {
                await github.rest.actions.deleteWorkflowRun({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  run_id: r.id,
                })
                deleted += 1
              }
            }

            core.info(`Deleted ${deleted} workflow runs.`)
